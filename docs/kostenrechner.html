<!DOCTYPE html>
<html class="scroll-smooth" lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Dachrinnenreinigung Preisrechner – jetzt Kosten online berechnen | DachrinneCheck</title>
  <meta name="description" content="Nutzen Sie den Dachrinnenreinigung Preisrechner von DachrinneCheck und berechnen Sie in wenigen Sekunden die Kosten für Ihre Dachrinnenreinigung in Willich, Krefeld, Düsseldorf & Umgebung. Richtpreis sofort & transparent.">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#0077B6",
            "primary-dark": "#005E90",
            "background-light": "#F8F9FA",
            "background-dark": "#1A202C",
            "text-light": "#6C757D",
            "text-dark": "#E2E8F0",
            "card-light": "#FFFFFF",
            "card-dark": "#2D3748",
          },
          fontFamily: {
            display: ["Poppins", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "0.5rem",
            lg: "0.75rem",
            xl: "1rem",
            full: "9999px",
          },
          boxShadow: {
            'custom': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)',
          }
        },
      },
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
  <style>
    /* Allgemeine Variablen */
    :root{
      --bg:#F8F9FA;
      --card:#FFFFFF;
      --ink:#0F172A;
      --muted:#6C757D;
      --accent:#0077B6;
      --cta:#0077B6;
      --cta-ink:#FFFFFF;
      --border:#E2E8F0;
      --warn:#b45309;
      --ok:#059669;
    }
    .dark{
      --bg:#1A202C;
      --card:#2D3748;
      --ink:#E2E8F0;
      --muted:#A0AEC0;
      --border:#2F3A4A;
    }
    *{box-sizing:border-box}

    /* Verbesserte Body/HTML-Einstellungen für Scrolling und Darstellung */
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:'Poppins',sans-serif;
      line-height:1.6;
      font-size:16px;
      -webkit-text-size-adjust:100%;
      min-height:100%;
      width:100%;
      max-width:100%;
      overflow-x:hidden; /* Verhindert horizontales Scrollen */
      overflow-y:auto; /* Erlaubt vertikales Scrollen im iFrame */
      -webkit-overflow-scrolling:touch; /* Verbessertes Scroll-Verhalten auf iOS */
      touch-action:pan-y; /* Erlaubt nur vertikales Panning, verhindert versehentliches horizontales Scrollen */
      overscroll-behavior-y:contain; /* Verhindert, dass Scrollen im iFrame das übergeordnete Fenster scrollt */
      transition:background-color .3s ease,color .3s ease;
    }

    /* Sicherstellen, dass Hauptcontainer flexibel sind, aber nicht überlaufen */
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:0 1.5rem 2.5rem;
      min-width:0; /* Verhindert Überlauf bei flexiblen Layouts */
      width:100%; /* Wichtig für die korrekte Breite im iFrame */
      display:flex;
      flex-direction:column;
      gap:24px;
    }

    .hero{
      position:relative;
      background:linear-gradient(140deg,rgba(0,119,182,0.14),rgba(0,119,182,0.04));
      border:1px solid rgba(0,0,0,0.04);
      border-radius:24px;
      padding:24px;
      margin-bottom:0;
      box-shadow:0 10px 25px -5px rgba(0,0,0,0.1),0 8px 10px -6px rgba(0,0,0,0.1);
      overflow:hidden;
    }
    .hero::after{
      content:"";
      position:absolute;
      inset:auto -40px -80px auto;
      width:240px;
      height:240px;
      background:radial-gradient(circle at center,rgba(0,119,182,0.3),transparent 60%);
      opacity:.6;
      pointer-events:none;
    }
    h1{margin:0 0 10px;font-size:clamp(28px,5vw,44px);font-weight:700;color:var(--ink);letter-spacing:-0.01em}
    p.lead{margin:0;color:var(--muted);font-size:1.05rem;max-width:52ch}

    .usps{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:18px}
    .usp{display:flex;gap:10px;align-items:center;font-size:.95rem;background:rgba(255,255,255,0.92);border:1px solid rgba(0,0,0,0.05);border-radius:14px;padding:12px 14px;box-shadow:0 12px 30px -18px rgba(15,23,42,0.4);backdrop-filter:blur(4px)}
    .usp svg{flex:0 0 18px}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:start;}
    @media (max-width:900px){.grid-2{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid rgba(15,23,42,0.08);border-radius:20px;padding:24px;display:flex;flex-direction:column;box-shadow:0 10px 25px -5px rgba(0,0,0,0.08),0 12px 20px -8px rgba(15,23,42,0.12)}
    .card h2{margin:0 0 12px;font-size:1.4rem;color:var(--ink);font-weight:700}

    .fields{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:16px;align-items:end}
    .fields-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:16px;align-items:end}
    .fields-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
    @media (max-width:720px){.fields,.fields-2,.fields-3{grid-template-columns:1fr}}

    .field{display:flex;flex-direction:column;gap:6px;min-width:0} /* min-width:0 ist hier gut, um Überlauf bei zu langen Eingaben zu vermeiden */
    label{font-weight:600;color:var(--ink);font-size:.95rem}

    input[type="text"],input[type="number"],input[type="email"],input[type="tel"],input[type="date"],select,textarea{
      width:100%;padding:12px 14px;border:1px solid rgba(15,23,42,0.12);border-radius:14px;background:rgba(255,255,255,0.96);outline:none;
      min-width:0; /* Sicherstellen, dass Input-Felder nicht überlaufen */
      transition:border-color .2s ease,box-shadow .2s ease,background-color .2s ease;
    }
    input:focus,textarea:focus,select:focus{box-shadow:0 0 0 4px rgba(0,119,182,0.15);border-color:rgba(0,119,182,0.45);background:#fff}
    input[readonly]{background:#f3f4f6}

    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:flex-start} /* Explizites justify-content */
    .hint{font-size:.9rem;color:var(--muted)}
    .map{height:220px;border-radius:12px;border:1px solid var(--border);overflow:hidden;pointer-events:none}

    .total{margin-top:auto;border-top:1px solid rgba(15,23,42,0.1);padding-top:18px;display:flex;justify-content:space-between;align-items:center}
    .price{font-weight:900;font-size:1.75rem;color:var(--accent)}

    .btn{appearance:none;border:0;border-radius:999px;padding:12px 20px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease,background-color .2s ease;
      touch-action: manipulation; /* Verbessert die Reaktionsfähigkeit auf Touch-Geräten */
      box-shadow:0 10px 20px -10px rgba(0,119,182,0.6);
      font-size:1rem;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 16px 30px -12px rgba(0,119,182,0.65);background:var(--cta)}
    .btn:active{transform:translateY(0);box-shadow:0 8px 18px -10px rgba(0,119,182,0.6)}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}
    .btn.secondary{background:#111827}
    .btn.cta{background:var(--cta);color:var(--cta-ink)}

    .stack{display:flex;flex-direction:column;gap:8px}
    .consent{display:flex;gap:10px;align-items:flex-start}
    .note{font-size:.85rem;color:var(--muted)}
    .minnote{color:var(--warn);font-size:.9rem}
    .error{color:#b91c1c;font-size:.85rem}
    .ok{color:var(--ok);font-size:.85rem}
    .note a{color:var(--accent);font-weight:600;text-decoration:none}
    .note a:hover{text-decoration:underline}

    .trust{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px}
    .trust .badge{background:rgba(255,255,255,0.96);border:1px solid rgba(15,23,42,0.08);border-radius:14px;padding:10px;text-align:center;font-size:.95rem;font-weight:600;color:var(--ink);box-shadow:0 10px 24px -14px rgba(15,23,42,0.35)}

    .dark .hero{background:linear-gradient(140deg,rgba(0,119,182,0.25),rgba(17,24,39,0.6));border-color:rgba(226,232,240,0.08)}
    .dark .hero::after{background:radial-gradient(circle at center,rgba(99,179,237,0.35),transparent 65%);opacity:.5}
    .dark .usp{background:rgba(45,55,72,0.9);border-color:rgba(226,232,240,0.12);color:var(--ink);box-shadow:0 18px 32px -20px rgba(0,0,0,0.65)}
    .dark .card{border-color:rgba(226,232,240,0.12);box-shadow:0 18px 30px -18px rgba(0,0,0,0.55)}
    .dark .card h2{color:var(--ink)}
    .dark input[type="text"],
    .dark input[type="number"],
    .dark input[type="email"],
    .dark input[type="tel"],
    .dark input[type="date"],
    .dark select,
    .dark textarea{background:rgba(30,41,59,0.82);border-color:rgba(226,232,240,0.18);color:var(--ink)}
    .dark input:focus,
    .dark textarea:focus,
    .dark select:focus{box-shadow:0 0 0 4px rgba(99,179,237,0.18);border-color:rgba(99,179,237,0.45);background:rgba(30,41,59,0.92)}
    .dark input[readonly]{background:rgba(45,55,72,0.8)}
    .dark .row label{background:rgba(30,41,59,0.82);border-color:rgba(226,232,240,0.18);color:var(--ink)}
    .dark .trust .badge{background:rgba(45,55,72,0.9);border-color:rgba(226,232,240,0.12);box-shadow:0 18px 34px -18px rgba(0,0,0,0.6)}
    .dark .note a{color:#63B3ED}
    .dark .guard-label{background:rgba(59,130,246,0.12);border-color:rgba(99,179,237,0.35)}

    /* Mobile spezifische Anpassungen */
    @media (max-width:720px){
      #calcCard .fields .field:nth-child(3){order:-1}
      .map{height:clamp(220px,50vw,360px)}
    }
    .mobile-total{display:none}

    @media (max-width:900px){
      .mobile-total{position:fixed;left:0;right:0;bottom:0;z-index:2000;background:rgba(255,255,255,0.95);border-top:1px solid rgba(15,23,42,0.08);padding:12px 16px calc(14px + env(safe-area-inset-bottom,0px));display:flex;align-items:center;justify-content:space-between;gap:14px;box-shadow:0 -12px 28px rgba(15,23,42,0.15);backdrop-filter:blur(8px)}
      .dark .mobile-total{background:rgba(26,32,44,0.94);border-top:1px solid rgba(226,232,240,0.12);box-shadow:0 -14px 32px rgba(0,0,0,0.45)}
      .mobile-total .price{font-size:1.35rem}
      /* padding-bottom anpassen, um den Fixed Footer zu berücksichtigen */
      .wrap{padding-bottom:calc(120px + env(safe-area-inset-bottom,0px));}
    }
    @media (max-width:900px){#btnSubmit{display:none !important}}

    /* --- Mobile polish & accessibility --- */
    @media (max-width:900px){
      input,select,textarea,button{ font-size:16px; }
      .btn{ padding:14px 20px; border-radius:18px; }
      .hero,.card{ padding:18px; }
      .row label{ padding:10px 12px; border:1px solid rgba(15,23,42,0.12); border-radius:14px; background:rgba(255,255,255,0.96); }
    }
    .row input[type="radio"]{ accent-color: var(--accent); }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:calc(110px + env(safe-area-inset-bottom,0px)); background:rgba(17,24,39,0.96); color:#fff; padding:14px 18px; border-radius:14px; box-shadow:0 18px 38px rgba(15,23,42,.35); z-index:3000; display:none; border:1px solid rgba(255,255,255,0.08); }
    .toast.show{ display:block; }

    /* --- Wix/mobile overflow guards --- */
    svg,img,canvas,video{max-width:100%;height:auto}

    /* --- Larger consent checkbox & mobile guard section --- */
    #cbConsent{ width:28px; height:28px; accent-color: var(--accent); vertical-align: top; }
    @media (max-width:900px){
      /* HIER IST DIE WICHTIGE ÄNDERUNG */
      #cbConsent{ transform: scale(1.3); /* Reduziert von 1.8 */ transform-origin: top left; }
      .consent{ gap:16px; }
    }

    .consent label.note{ line-height:1.7; }

    /* Subtle highlight for guard label */
    .guard-label{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:12px; background:rgba(27,56,152,0.06); font-weight:700; }
    .guard-label input{ width:20px; height:20px; accent-color: var(--accent); }
    @media (max-width:900px){
      .guard-label{ padding:8px 12px; }
      .guard-label input{ width:22px; height:22px; }
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
  <div class="relative w-full overflow-x-hidden" x-data="{ mobileMenuOpen: false }">
    <header @scroll.window="scrolled = window.scrollY &gt; 10" class="sticky top-0 z-30 bg-white/80 dark:bg-background-dark/80 backdrop-blur-lg shadow-md transition-all duration-300" x-data="{ scrolled: false }">
      <div class="container mx-auto flex justify-between items-center px-4 py-3">
        <a class="inline-flex items-center" href="index.html">
          <img alt="DachrinneCheck Logo" class="h-12 md:h-14 w-auto" src="assets/img/dachrinnecheck-logo.svg"/>
          <span class="sr-only">Zur Startseite</span>
        </a>
        <div class="hidden md:flex items-center space-x-6">
          <a class="text-gray-600 dark:text-text-dark hover:text-primary dark:hover:text-primary transition-colors" href="index.html#services">Services</a>
          <a class="text-gray-600 dark:text-text-dark hover:text-primary dark:hover:text-primary transition-colors" href="index.html#about">Über uns</a>
          <a class="text-gray-600 dark:text-text-dark hover:text-primary dark:hover:text-primary transition-colors" href="#kontakt">Kontakt</a>
          <a class="bg-primary text-white font-semibold py-2 px-5 rounded-full text-sm hover:bg-primary-dark transition-all duration-300 shadow transform hover:scale-105" href="#kontakt">
            Angebot anfordern
          </a>
        </div>
        <div class="md:hidden">
          <button @click="mobileMenuOpen = !mobileMenuOpen" class="text-gray-900 dark:text-white p-2" aria-label="Menü öffnen">
            <span class="material-symbols-outlined text-3xl">menu</span>
          </button>
        </div>
      </div>
      <div :class="{'max-h-96': mobileMenuOpen, 'max-h-0': !mobileMenuOpen}" class="md:hidden overflow-hidden transition-all duration-500 ease-in-out">
        <div class="flex flex-col items-center space-y-4 py-4 border-t border-gray-200 dark:border-gray-700">
          <a @click="mobileMenuOpen = false" class="text-gray-600 dark:text-text-dark hover:text-primary dark:hover:text-primary transition-colors py-2" href="index.html#services">Services</a>
          <a @click="mobileMenuOpen = false" class="text-gray-600 dark:text-text-dark hover:text-primary dark:hover:text-primary transition-colors py-2" href="index.html#about">Über uns</a>
          <a @click="mobileMenuOpen = false" class="text-gray-600 dark:text-text-dark hover:text-primary dark:hover:text-primary transition-colors py-2" href="#kontakt">Kontakt</a>
          <a @click="mobileMenuOpen = false" class="bg-primary text-white font-semibold py-3 px-8 rounded-full text-base hover:bg-primary-dark transition-all duration-300 shadow-lg transform hover:scale-105 mt-4" href="#kontakt">
            Angebot anfordern
          </a>
        </div>
      </div>
    </header>
    <main class="pt-24 pb-24">
      <div class="px-4">
        <div class="wrap">
          <section class="hero" id="preisrechner">
            <span class="inline-flex items-center text-xs md:text-sm font-semibold tracking-widest uppercase text-primary bg-white/80 dark:bg-white/10 border border-primary/10 dark:border-white/10 rounded-full px-4 py-1 mb-4">Sofortige Kostenschätzung</span>
            <h1 class="text-gray-900 dark:text-white">Dachrinnenreinigung Preisrechner – jetzt Kosten online berechnen</h1>
            <p class="lead text-text-light dark:text-text-dark">Nutzen Sie unseren Dachrinnenreinigung Preisrechner und berechnen Sie in wenigen Sekunden die Kosten für Ihre Dachrinnenreinigung in Willich, Krefeld, Düsseldorf &amp; Umgebung. Der Richtpreis ist transparent und beinhaltet Anfahrt, Rüstzeiten und Zuschläge.</p>

            <div class="usps">
              <div class="usp"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M20 6L9 17l-5-5"/></svg><span class="text-gray-700 dark:text-text-dark">Schnelle Rückmeldung <b>≤ 24 h</b></span></div>
              <div class="usp"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><path d="M8 12l2 2 4-4"/></svg><span class="text-gray-700 dark:text-text-dark">Versichert &amp; Sicher bis <b>14 m</b></span></div>
              <div class="usp"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M3 12h18M3 6h18M3 18h18"/></svg><span class="text-gray-700 dark:text-text-dark">Transparenter Richtpreis – <b>ohne Überraschungen</b></span></div>
            </div>
          </section>

          <div class="grid-2" id="calculator">
            <section class="card bg-card-light dark:bg-card-dark" id="calcCard">
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Jetzt Richtpreis berechnen &amp; Anfrage absenden</h2>

              <div class="fields-2">
                <div class="field" style="grid-column:1/-1">
                  <label>Reinigungstyp</label>
                  <div class="row">
                    <label><input type="radio" name="typ" value="Erstreinigung" checked> Erstreinigung</label>
                    <label><input type="radio" name="typ" value="Folgereinigung"> Folgereinigung</label>
                  </div>
                </div>
                <div class="field">
                  <label for="lfm">Länge Dachrinne [lfm]</label>
                  <input id="lfm" type="number" min="1" step="0.5" value="12" inputmode="decimal" required />
                </div>
                <div class="field">
                  <label for="hoehe">Höhe Dachrinne [m]</label>
                  <input id="hoehe" type="number" min="2" step="0.1" value="6.0" inputmode="decimal" required />
                </div>
              </div>

              <div class="fields" style="margin-top:4px">
                <div class="field" style="grid-column:1/-1">
                  <label for="adresse">Objektadresse</label>
                  <input id="adresse" type="text" placeholder="Straße Hausnr, PLZ Ort" list="addrList" autocomplete="street-address" maxlength="120" />
                  <datalist id="addrList"></datalist>
                  <div class="hint">Distanz ab DachrinneCheck wird berechnet</div>
                </div>
                <div class="field">
                  <label>Entfernung [km]</label>
                  <input id="km" type="number" readonly placeholder="Automatisch ermittelt" />
                </div>
                <div class="field">
                  <label>Map-Vorschau</label>
                  <div id="map" class="map"></div>
                </div>
              </div>

              <div class="fields" style="margin-top:4px">
                <div class="field" style="grid-column:1/-1">
                  <label class="guard-label"><input id="schutzVorhanden" type="checkbox" /> Dachrinnenschutz vorhanden?</label>
                </div>
              </div>

              <div id="schutzSection" class="fields-3" style="margin-top:8px">
                <div class="field">
                  <label>Reinigung Dachrinnenschutz [lfm]</label>
                  <input id="schutzReinigung" type="number" min="0" step="1" value="0" inputmode="numeric" />
                </div>
                <div class="field">
                  <label>Montage Laubschutz [lfm]</label>
                  <input id="schutzMontage" type="number" min="0" step="1" value="0" inputmode="numeric" />
                </div>
                <div class="field">
                  <label>Demontage Laubschutz [lfm]</label>
                  <input id="schutzDemontage" type="number" min="0" step="1" value="0" inputmode="numeric" />
                </div>
                <div class="field" style="grid-column:1/-1">
                  <div class="note">Bei <b>Höhe &gt; 5 m</b> mit vorhandenem Schutz wird <b>automatisch ein Steiger</b> berücksichtigt.</div>
                </div>
              </div>

              <div class="total">
                <div class="stack">
                  <div class="note">Voraussichtlicher Endpreis (Richtwert)</div>
                  <div class="price" id="endpreis">–</div>
                  <div class="minnote" id="minnote" style="display:none">Mindestauftrag angewandt.</div>
                  <div class="note">Diese Woche noch freie Slots – jetzt anfragen.</div>
                </div>
              </div>
            </section>

            <section class="card bg-card-light dark:bg-card-dark" id="kontakt">
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Kontakt &amp; Anfrage</h2>
              <form id="kontaktForm" class="stack" novalidate>
                <div class="fields">
                  <div class="field"><label>Vorname</label><input id="inFirst" type="text" required maxlength="40" autocomplete="given-name" /></div>
                  <div class="field"><label>Nachname</label><input id="inLast" type="text" required maxlength="40" autocomplete="family-name" /></div>
                  <div class="field">
                    <label>E-Mail</label>
                    <input id="inEmail" type="email" required autocomplete="email" inputmode="email" maxlength="80"
                           pattern="^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$" />
                    <div id="emailMsg" class="error" style="display:none">Bitte eine gültige E-Mail angeben (z.B. name@domain.de).</div>
                  </div>
                  <div class="field">
                    <label>Telefon</label>
                    <input id="inPhone" type="tel" required autocomplete="tel" inputmode="tel" maxlength="25"
                           pattern="^\+?[0-9 ()\-/]{6,20}$" />
                    <div id="phoneMsg" class="error" style="display:none">Bitte eine gültige Telefonnummer angeben.</div>
                  </div>
                  <div class="field" style="grid-column:1/-1"><label>Objektadresse</label><input id="inFormAddress" type="text" readonly /></div>
                  <div class="field"><label>Wunschtermin</label><input id="dpWish" type="date" /></div>
                  <div class="field" style="grid-column:1/-1;min-height:auto"><label>Nachricht (optional)</label><textarea id="inMsg" rows="4" placeholder="Besonderheiten / Zugang / Wunschzeiten …" maxlength="1000"></textarea></div>
                </div>

                <div class="consent">
                  <input type="checkbox" id="cbConsent" required />
                  <label for="cbConsent" class="note">
                    Ich willige ein, dass meine Angaben zur Kontaktaufnahme, Angebotserstellung und Terminabstimmung verarbeitet und gespeichert werden.
                    Die Einwilligung kann ich jederzeit mit Wirkung für die Zukunft widerrufen. Hinweise in der
                    <a href="datenschutz.html" target="_blank" rel="noopener">Datenschutzerklärung</a>.
                  </label>
                </div>

                <button class="btn cta" id="btnSubmit" disabled>Anfrage absenden</button>

                <div class="note">
                  Mit dem Absenden werden Ihre Angaben zusammen mit der Kalkulation an unser Postfach übermittelt.
                  Für die Distanzberechnung nutzen wir OpenStreetMap (Nominatim/OSRM).
                </div>

                <div class="trust">
                  <div class="badge">✓ Regional aus Willich</div>
                  <div class="badge">✓ Fest installiertes Profi-System</div>
                  <div class="badge">✓ Termin nach Arbeit möglich</div>
                </div>
              </form>
            </section>
          </div>
        </div>
      </div>

      <div class="mobile-total" id="mobileTotal" aria-live="polite" role="status">
        <div>
          <div class="note">Richtpreis</div>
          <div class="price" id="endpreis_mobile">–</div>
        </div>
        <button class="btn" id="btnStickySubmit" type="button" onclick="document.getElementById('kontaktForm').requestSubmit();" disabled>Anfrage absenden</button>
      </div>
    </main>

    <footer class="bg-card-dark border-t border-gray-800 py-10 md:py-12">
      <div class="container mx-auto px-4 text-center text-text-dark">
        <div class="flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-8 mb-8">
          <a class="hover:text-primary transition-colors text-sm" href="datenschutz.html">Datenschutz</a>
          <a class="hover:text-primary transition-colors text-sm" href="#">AGB</a>
          <a class="hover:text-primary transition-colors text-sm" href="#kontakt">Kontakt</a>
        </div>
        <p class="text-xs">© 2024 DachrinneCheck. Alle Rechte vorbehalten.</p>
      </div>
    </footer>
  </div>

  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script>
  /* ===== Konfiguration ===== */
  const START_ADDR = "Ackerstraße 39, 47877 Willich, Germany";
  const START = { lat: 51.263, lon: 6.546 };
  const GEOCACHE = {};
  let LAST_ADDR = "";
  let LAST_KM = 0;

  // Pfad bleibt für Standalone-Betrieb (außerhalb iFrame)
  const FUNCTIONS_BASE = (location.hostname.includes('wixsite') || location.hostname.includes('editor')) ? '/_functions-dev' : '/_functions';
  const WEBHOOK_URL = `${FUNCTIONS_BASE}/webhookbridge`;

  const PARAMS = { eurKm: 1.0, setup: 40, minPrice: 125, ladder: 40, steiger: 340 };
  const RATES = {
    ERST:[{min:2,max:3.99,price:5},{min:4,max:5.99,price:7},{min:6,max:7.99,price:9},{min:8,max:9.99,price:12},{min:10,max:999,price:15}],
    FOLGE:[{min:2,max:3.99,price:4},{min:4,max:5.99,price:5},{min:6,max:7.99,price:7},{min:8,max:9.99,price:10},{min:10,max:999,price:15}]
  };

  const $ = s => document.querySelector(s);
  function euro(x){return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(x);}  
  function bandPrice(type, height){
    const arr = type === "Erstreinigung" ? RATES.ERST : RATES.FOLGE;
    const h = Number(height)||0;
    for(const b of arr){ if(h>=b.min && h<=b.max) return b.price; }
    return arr[arr.length-1].price;
  }

  // ===== Leaflet Map =====
  const NRW_BOUNDS = L.latLngBounds([[50.3,5.9],[52.6,9.6]]);
  let map = L.map('map', {zoomControl:false});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap',
    updateWhenIdle:true,
    updateWhenZooming:false,
    keepBuffer:1,
    maxZoom:18
  }).addTo(map);
  map.setMaxBounds(NRW_BOUNDS);
  map.dragging.disable(); map.scrollWheelZoom.disable(); map.doubleClickZoom.disable(); map.touchZoom.disable(); map.boxZoom.disable(); map.keyboard.disable();
  map.fitBounds(NRW_BOUNDS);
  let startMarker, destMarker;

  async function geocode(addr){
    if (GEOCACHE[addr]) return GEOCACHE[addr];
    const u = new URL("https://nominatim.openstreetmap.org/search");
    u.searchParams.set("format","jsonv2");
    u.searchParams.set("limit","1");
    u.searchParams.set('viewbox','5.9,52.6,9.6,50.3');
    u.searchParams.set('bounded','1');
    u.searchParams.set('q', addr);
    u.searchParams.set('accept-language','de');
    const r = await fetch(u);
    if(!r.ok) throw new Error("Geocoding fehlgeschlagen");
    const j = await r.json();
    if(!j?.length) throw new Error("Adresse nicht gefunden");
    const res = { lat:+j[0].lat, lon:+j[0].lon };
    GEOCACHE[addr] = res;
    return res;
  }

  async function routeKm(from, to){
    const url = `https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=false&alternatives=false`;
    const r = await fetch(url);
    if(!r.ok) throw new Error("Routing fehlgeschlagen");
    const j = await r.json();
    const meters = j?.routes?.[0]?.distance || 0;
    return meters/1000;
  }

  // ===== Address Autocomplete =====
  let acTimer; let acCtl; let lastQuery = "";
  const addrInput = $('#adresse');
  const addrList = $('#addrList');

  addrInput.addEventListener('input', () => {
    addrInput.value = sanitizeText(addrInput.value);
    const q = addrInput.value.trim();
    clearTimeout(acTimer);
    if(q.length < 3){ addrList.innerHTML=''; return; }
    if(q === lastQuery) return; lastQuery = q;
    acTimer = setTimeout(async () => {
      try{
        const u = new URL('https://nominatim.openstreetmap.org/search');
        u.searchParams.set('format','jsonv2');
        u.searchParams.set('addressdetails','0');
        u.searchParams.set('limit','5');
        u.searchParams.set('countrycodes','de');
        u.searchParams.set('viewbox','5.9,52.6,9.6,50.3'); // NRW-Beschränkung
        u.searchParams.set('bounded','1');
        u.searchParams.set('q', q);
        u.searchParams.set('accept-language','de');
        if (acCtl) acCtl.abort();
        const r = await fetch(u, { signal: (acCtl = new AbortController()).signal });
        if(!r.ok) return;
        const data = await r.json();
        addrList.innerHTML = data.map(x => `<option value="${escapeHtml(x.display_name)}"></option>`).join('');
      }catch(e){ /* ignore */ }
    }, 300);
  });
  addrInput.addEventListener('change', recalc);

  function toggleGuard(){
    const sec = document.getElementById('schutzSection');
    const isChecked = document.getElementById('schutzVorhanden').checked;
    if (sec) {
      sec.style.display = isChecked ? 'grid' : 'none';
      sec.setAttribute('aria-hidden', !isChecked);
    }
    if (window.__postHeight) window.__postHeight();
  }

  function autoActivateGuard(){
    const ids = ['schutzReinigung','schutzMontage','schutzDemontage'];
    const anyVal = ids.some(id => {
      const el = document.getElementById(id);
      return (parseFloat(el && el.value ? el.value : 0) || 0) > 0;
    });
    if (anyVal) {
      const cb = document.getElementById('schutzVorhanden');
      if (cb && !cb.checked) {
        cb.checked = true;
        if (window.__postHeight) window.__postHeight();
        try{ recalc(); }catch(e){}
        toggleGuard(); // Richtiges Anzeigen der Sektion
      }
    }
  }

  async function recalc(){
    const typ = document.querySelector('input[name="typ"]:checked').value;
    const lfm = parseFloat($('#lfm').value||0);
    const hoehe = parseFloat($('#hoehe').value||0);
    const addr = ($('#adresse').value||"").trim();

    let kmEinfach = parseFloat($('#km').value||0);
    if(addr){
      try{
        const from = START;
        if (addr !== LAST_ADDR) {
          const to = await geocode(addr);
          const km = await routeKm(from, to);
          LAST_ADDR = addr; LAST_KM = km;
          $('#km').value = km.toFixed(1);
          kmEinfach = km;

          if (!startMarker) startMarker = L.marker([from.lat, from.lon]).addTo(map).bindPopup("Start");
          else startMarker.setLatLng([from.lat, from.lon]);

          if (!destMarker) destMarker = L.marker([to.lat, to.lon]).addTo(map).bindPopup("Ziel");
          else destMarker.setLatLng([to.lat, to.lon]);

          const bounds = L.latLngBounds([[from.lat,from.lon],[to.lat,to.lon]]);
          map.fitBounds(bounds.pad(0.25));
        } else {
          $('#km').value = LAST_KM ? LAST_KM.toFixed(1) : '';
          kmEinfach = LAST_KM || 0;
        }
      }catch(e){ console.warn(e); $('#km').value = ''; LAST_KM = 0; } // Bei Fehler km zurücksetzen
    } else {
        $('#km').value = ''; LAST_KM = 0; // Wenn Adresse leer, dann km auch leer
        if (startMarker) map.removeLayer(startMarker); startMarker = null;
        if (destMarker) map.removeLayer(destMarker); destMarker = null;
        map.fitBounds(NRW_BOUNDS); // Karte auf NRW zurücksetzen
    }

    const hasGuard = $('#schutzVorhanden').checked;
    const guardClean = hasGuard ? parseFloat($('#schutzReinigung').value||0) : 0;
    const guardMount = hasGuard ? parseFloat($('#schutzMontage').value||0) : 0;
    const guardDemount = hasGuard ? parseFloat($('#schutzDemontage').value||0) : 0;

    const rate = bandPrice(typ, hoehe);
    let sum = 0;
    sum += lfm * rate;
    sum += (kmEinfach * 2) * PARAMS.eurKm;
    sum += PARAMS.setup;

    if(hasGuard){
      sum += guardClean * rate;
      sum += guardMount * rate;
      sum += guardDemount * rate;
    }

    const needSteiger = hasGuard && hoehe > 5 && (guardClean + guardMount + guardDemount > 0);
    if(needSteiger){ sum += PARAMS.steiger; }
    else if(hoehe > 6){ sum += PARAMS.ladder; }

    const minApplied = sum < PARAMS.minPrice;
    if(minApplied) sum = PARAMS.minPrice;

    $('#endpreis').textContent = euro(sum);
    const mob = document.getElementById('endpreis_mobile'); if(mob) mob.textContent = euro(sum);
    document.getElementById('minnote').style.display = minApplied ? 'block' : 'none';

    $('#inFormAddress').value = addr;

    window._payload = {
      typ, lfm, hoehe, adresse: addr, km_einfach: kmEinfach,
      schutz: hasGuard ? "ja" : "nein",
      schutz_clean: guardClean, schutz_mont: guardMount, schutz_demont: guardDemount,
      endpreis: Number(sum.toFixed(2)),
      eur_km: PARAMS.eurKm, setup: PARAMS.setup, ladder: PARAMS.ladder, steiger: PARAMS.steiger,
      minpreis: PARAMS.minPrice, ts: new Date().toISOString()
    };

    if (window.__postHeight) window.__postHeight();
  }

  /* ===== Bridge: iFrame -> Wix-Seite ===== */
  const IN_IFRAME = (() => { try { return window.self !== window.top; } catch { return true; } })();

  function sendViaParent(body, timeoutMs = 15000){
    return new Promise((resolve) => {
      if (!IN_IFRAME) return resolve({ ok:false, status:0, text:'not-in-iframe' });
      const token = Math.random().toString(36).slice(2);
      const onMsg = (ev) => {
        const d = ev.data;
        if (!d || d.type !== 'webhookbridge:result' || d.token !== token) return;
        window.removeEventListener('message', onMsg);
        clearTimeout(timer);
        resolve({ ok: !!d.ok, status: d.status, text: d.text || '' });
      };
      window.addEventListener('message', onMsg);
      window.parent.postMessage({ type:'webhookbridge:submit', token, body }, '*');
      const timer = setTimeout(() => {
        window.removeEventListener('message', onMsg);
        resolve({ ok:false, status:408, text:'Bridge timeout – keine Antwort von Wix-Seite.' });
      }, timeoutMs);
    });
  }

  /* ===== Debug: Ready-Signal vom Parent ===== */
  window.addEventListener('message', (ev) => {
    if (ev?.data?.type === 'webhookbridge:ready') {
      console.log('Bridge ready from parent');
    }
  });

  // ===== Toast helper (mobile-friendly) =====
  function showToast(msg){
    const t = document.getElementById('toast');
    if(!t){ alert(msg); return; }
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=> t.classList.remove('show'), 2800);
  }

  // ===== Input sanitization =====
  function escapeHtml(str){
    return String(str).replace(/[&<>"'`]/g, s => ({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":'&#39;',
      '`':'&#96;'
    }[s]));
  }
  function sanitizeText(str){ return String(str).replace(/[<>\u0000-\u001F]/g, '').trimStart(); }
  function sanitizeName(str){ return String(str).replace(/[^A-Za-zÀ-ÿ \-']/g, ''); }
  function sanitizeTel(str){ return String(str).replace(/[^0-9 +()\-\/]/g, ''); }

  ['inFirst','inLast','inMsg'].forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener('input', () => { el.value = (id==='inMsg'? sanitizeText(el.value) : sanitizeName(el.value)); });
  });
  document.getElementById('inPhone').addEventListener('input', e => { e.target.value = sanitizeTel(e.target.value); });
  document.getElementById('adresse').addEventListener('input', e => { e.target.value = sanitizeText(e.target.value); });

  // ===== Email & Phone validation feedback =====
  const emailEl = document.getElementById('inEmail');
  const phoneEl = document.getElementById('inPhone');
  const emailMsg = document.getElementById('emailMsg');
  const phoneMsg = document.getElementById('phoneMsg');
  function showValidity(el, msgEl){ if(el.validity.valid){ msgEl.style.display = 'none'; } else { msgEl.style.display = 'block'; } }
  emailEl.addEventListener('input', () => showValidity(emailEl, emailMsg));
  phoneEl.addEventListener('input', () => showValidity(phoneEl, phoneMsg));

  async function submitForm(e){
    e.preventDefault();

    showValidity(emailEl, emailMsg);
    showValidity(phoneEl, phoneMsg);
    if(!document.getElementById('kontaktForm').checkValidity()){
      document.getElementById('kontaktForm').reportValidity();
      return;
    }
    if(!document.getElementById('cbConsent').checked){
      showToast("Bitte stimmen Sie der Datenverarbeitung zu.");
      return;
    }

    await recalc();

    const contact = {
      vorname: sanitizeName(document.getElementById('inFirst').value.trim()),
      nachname: sanitizeName(document.getElementById('inLast').value.trim()),
      email: emailEl.value.trim(),
      telefon: phoneEl.value.trim(),
      nachricht: sanitizeText(document.getElementById('inMsg').value),
      wunschtermin: document.getElementById('dpWish').value || ""
    };
    const payload = window._payload || {};
    const body = { meta: { source: "preisrechner-html", version: "1.2.0", timestamp: new Date().toISOString() }, contact, payload, consent: "ja" };

    let ok=false, status=0, text='';

    // 1) Wenn NICHT im iFrame: Direkt an Velo-Funktion posten (mit Fallbacks)
    if (!IN_IFRAME) {
      const urls = [
        WEBHOOK_URL, // /_functions-oder-/_functions-dev
        '/_functions/webhookbridge',
        '/_functions-dev/webhookbridge',
        'https://www.dachrinnecheck.de/_functions/webhookbridge' // absolute Live-Domain
      ];
      for (const url of urls) {
        try {
          const resp = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
          status = resp.status; text = await resp.text(); ok = resp.ok;
          if (ok) break;
        } catch (err) {
          status = 0; text = String(err); ok = false;
        }
      }
    }

    // 2) Im iFrame (oder wenn 1) fehlschlug): über Wix-Seite bridgen
    if (!ok) {
      const res = await sendViaParent(body);
      ok = res.ok; status = res.status; text = res.text;
    }

    if(!ok){
      console.error('Bridge error:', status, text);
      showToast(`Online-Übermittlung fehlgeschlagen (Bridge ${status}). ${text || ""}`);
      return;
    }

    showToast("Danke! Ihre Anfrage ist eingegangen. Wir melden uns kurzfristig.");
    document.getElementById('kontaktForm').reset();
    const b1 = document.getElementById('btnSubmit'); if (b1) b1.disabled = true;
    const sbtn = document.getElementById('btnStickySubmit'); if (sbtn) sbtn.disabled = true;
    // Blur focused fields and scroll to top to avoid mobile zoom sticking around
    document.querySelectorAll('input,textarea,select').forEach(el=>el.blur());
    window.scrollTo({ top: 0, behavior: 'smooth' });
    updateSubmitState();

    // --- Auto-Resize: Höhe an Wix melden (verbesserter Mechanismus) ---
    (function(){
      let raf = 0;
      function postHeight(){
        if(raf) return; raf = requestAnimationFrame(()=>{
          raf = 0;
          // Die Berechnung der Höhe sollte robust sein
          const h = document.body.scrollHeight; // body.scrollHeight ist oft die zuverlässigste
          try{
            // console.log('Posting height:', h); // Debugging-Ausgabe
            window.parent.postMessage({ type:'embed:height', height:h }, '*');
          }catch(e){
            // console.error('Error posting height to parent:', e);
          }
        });
      }
      window.__postHeight = postHeight; // Verfügbar machen für andere Funktionen
      window.addEventListener('load', postHeight);
      window.addEventListener('resize', postHeight); // Auch bei Resize posten
      try{ new ResizeObserver(postHeight).observe(document.body); }catch(e){}
      try{ new MutationObserver(postHeight).observe(document.body, { childList:true, subtree:true, attributes:true }); }catch(e){}
      // Zusätzliche Timouts für den Fall, dass Observer nicht greifen oder initiale Renderzeit länger ist
      setTimeout(postHeight, 300);
      setTimeout(postHeight, 1000);
      setTimeout(postHeight, 3000); // Eine letzte Verzögerung, falls alles andere fehlschlägt
    })();
  }

  function updateSubmitState(){
    const form = document.getElementById('kontaktForm');
    const consent = document.getElementById('cbConsent').checked;
    const valid = form.checkValidity();
    const enable = consent && valid;
    const b1 = document.getElementById('btnSubmit'); if (b1) b1.disabled = !enable;
    const b2 = document.getElementById('btnStickySubmit'); if (b2) b2.disabled = !enable;
  }

  /* ===== Events ===== */
  document.getElementById('schutzVorhanden').addEventListener('change', toggleGuard);
  // Entfernt window.addEventListener('resize', toggleGuard); da es jetzt in postHeight ist und dort robuster platziert werden kann
  ['lfm','hoehe','schutzReinigung','schutzMontage','schutzDemontage']
    .forEach(id => { const el = document.getElementById(id); if(el) el.addEventListener('input', recalc); });
  document.querySelectorAll('input[name="typ"]').forEach(r => r.addEventListener('change', recalc));
  document.getElementById('kontaktForm').addEventListener('submit', submitForm);
  document.getElementById('cbConsent').addEventListener('change', updateSubmitState);
  // Auto-activate guard checkbox when user types values
  ['schutzReinigung','schutzMontage','schutzDemontage'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', autoActivateGuard);
  });
  document.querySelectorAll('#kontaktForm input, #kontaktForm textarea, #kontaktForm select').forEach(el => {
    el.addEventListener('input', updateSubmitState);
    el.addEventListener('change', updateSubmitState);
  });

  // Init
  toggleGuard();
  try { recalc(); } catch (e) { console.error('recalc init failed', e); }
  updateSubmitState();
  </script>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
</body>
</html>
